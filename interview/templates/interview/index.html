<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Interviewer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1c6073, #fef6fb);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background: #fff;
            width: 600px;
            max-width: 90%;
            padding: 40px 30px;
            border-radius: 16px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        h2 { text-align: center; color: #333; margin-bottom: 10px; }
        .section { display: flex; flex-direction: column; gap: 6px; }
        .box {
            background: #f4f6f8;
            padding: 14px 16px;
            border-radius: 10px;
            min-height: 60px;
            font-size: 15px;
            color: #1f2937;
            line-height: 1.4;
            overflow-wrap: break-word;
            border: 1px solid #e5e7eb;
        }

        .button-group { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-top: 10px; }
        button { padding: 10px 18px; font-size: 14px; font-weight: 500; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        button.primary { background: #2563eb; color: white; }
        button.success { background: #16a34a; color: white; }
        button.danger { background: #dc2626; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        audio { width: 100%; margin-top: 5px; border-radius: 8px; }
        .label { font-weight: 600; color: #111827; }
    </style>
</head>
<body>
    <body>

<input type="hidden" id="csrfToken" value="{{ csrf_token }}">

<div class="container">


    <h2>AI Interviewer</h2>

    <div class="section">
        <span class="label">INTERVIEWER:</span>
        <div class="box" id="aiText">Click "Start Interview" to begin</div>
    </div>

    <div class="section">
        <span class="label">CANDIDATE:</span>
        <div class="box" id="userText">Your speech will appear here</div>
    </div>

    <div class="section button-group">
        <button id="startBtn" class="primary">Start Interview</button>
        <button id="recordBtn" class="success" disabled>Start Answer</button>
        <button id="doneBtn" class="danger" disabled>Done</button>
    </div>

    <audio id="audioPlayer" controls></audio>
</div>

<script>
    function getCSRFToken() {
    return document.getElementById("csrfToken").value;
}
document.addEventListener("DOMContentLoaded", () => {

    let mediaRecorder, audioChunks = [], streamRef, timeout;
    let videoStream, videoRecorder, videoChunks = [];

    const aiTextEl = document.getElementById("aiText");
    const userTextEl = document.getElementById("userText");
    const audioPlayer = document.getElementById("audioPlayer");
    const startBtn = document.getElementById("startBtn");
    const recordBtn = document.getElementById("recordBtn");
    const doneBtn = document.getElementById("doneBtn");

    // ------------- TIMER -------------
    function startTimer() {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            aiTextEl.innerText = "Ok, your interview is over. Thank you for your time.";
            recordBtn.disabled = true;
            doneBtn.disabled = true;
            await stopVideoRecording();
        }, 10000); // 30s inactivity
    }
    function clearTimer() { clearTimeout(timeout); }

    // ------------- PLAY AI AUDIO -------------
    async function playAIAudio(url) {
        return new Promise(resolve => {
            audioPlayer.src = url;
            audioPlayer.play().catch(err => console.warn("Audio autoplay blocked:", err));
            audioPlayer.onended = () => { startTimer(); resolve(); };
        });
    }

    // ------------- VIDEO RECORDING -------------
    async function startVideoRecording() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            videoRecorder = new MediaRecorder(videoStream);
            videoChunks = [];
            videoRecorder.ondataavailable = e => { if(e.data.size>0) videoChunks.push(e.data); };
            videoRecorder.start();
            console.log("Video recording started...");
        } catch(err) {
            console.error("Video recording failed:", err);
        }
    }

    async function stopVideoRecording() {
        if(!videoRecorder || videoRecorder.state === "inactive") return;
        return new Promise(resolve => {
            videoRecorder.onstop = async () => {
    videoStream.getTracks().forEach(t => t.stop());
    const blob = new Blob(videoChunks, { type: "video/webm" });

    const form = new FormData();
    form.append('file', blob, `interview_${Date.now()}.webm`);
    form.append('upload_preset', 'ai_interview');

    const cloudName = 'dmirffn2y';
    const url = `https://api.cloudinary.com/v1_1/dmirffn2y/auto/upload`;

    try {
        const res = await fetch(url, { method: "POST", body: form });
        const data = await res.json();
        console.log("Video uploaded:", data.secure_url);
    } catch(err) {
        console.error("Cloudinary upload failed:", err);
    }

    resolve();
};
            videoRecorder.stop();
        });
    }

    // ------------- START INTERVIEW -------------
    startBtn.addEventListener("click", async () => {
        aiTextEl.innerText = "AI is starting...";
        userTextEl.innerText = "";
        recordBtn.disabled = true;
        doneBtn.disabled = true;

        try {
           const res = await fetch("/start/", {
    method: "POST",
    headers: {
        "X-CSRFToken": getCSRFToken()
    }
});
            const data = await res.json();

            aiTextEl.innerText = data.ai_text || "[No response]";
            localStorage.setItem("session_key", data.session_key);

            await startVideoRecording();

            const audioURL = `/tts_audio?text=${encodeURIComponent(data.ai_text)}`;
            await playAIAudio(audioURL);

            recordBtn.disabled = false;
            doneBtn.disabled = false;
            startTimer();
        } catch(err) {
            console.error(err);
            aiTextEl.innerText = "Error starting interview.";
        }
    });

    // ------------- RECORD AUDIO -------------
    recordBtn.addEventListener("click", async () => {
        clearTimer();
        userTextEl.innerText = "Recording...";
        recordBtn.disabled = true;
        doneBtn.disabled = false;

        try {
            streamRef = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(streamRef);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.start();
        } catch(err) {
            console.error(err);
            userTextEl.innerText = "Cannot access microphone.";
            recordBtn.disabled = false;
        }
    });

    // ------------- STOP AUDIO & SEND TO AI -------------
    doneBtn.addEventListener("click", async () => {
        doneBtn.disabled = true;
        if(!mediaRecorder) return;

        mediaRecorder.stop();
        mediaRecorder.onstop = async () => {
            streamRef.getTracks().forEach(t => t.stop());
            const blob = new Blob(audioChunks, { type: "audio/webm" });

            if(blob.size < 1000) {
                userTextEl.innerText = "[No speech detected]";
                recordBtn.disabled = false;
                doneBtn.disabled = false;
                return;
            }

            // Transcribe
            let candidateAnswer = "[Transcription failed]";
            try {
                const form = new FormData();
                form.append("audio_file", blob);
                 const res = await fetch("/transcribe/", {
    method: "POST",
    headers: {
        "X-CSRFToken": getCSRFToken()
    },
    body: form
});
                const data = await res.json();
                candidateAnswer = data.text || "[No transcription]";
                userTextEl.innerText = candidateAnswer;
            } catch (err) { console.error("Transcription error:", err); }

            // Send to AI
            try {
                const res2 = await fetch("/interview/", {
    method: "POST",
    headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCSRFToken()
    },
    body: `audio_text=${encodeURIComponent(candidateAnswer)}`
});
                const aiData = await res2.json();
                aiTextEl.innerText = aiData.ai_text || "[No response]";

                const audioURL = `/tts_audio?text=${encodeURIComponent(aiData.ai_text)}`;
                await playAIAudio(audioURL);
            } catch(err) { console.error("AI response error:", err); }

            recordBtn.disabled = false;
            doneBtn.disabled = false;
            startTimer();
        };
    });

});
</script>
</body>
</html>
